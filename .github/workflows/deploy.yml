name: Blue-Green Deployment
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Blue-Green
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/imanolcamacho098/blue-green-dulce

            # Resetear cambios locales y actualizar repo
            git reset --hard HEAD
            git pull origin main

            # Dar permisos a scripts
            chmod +x scripts/*.sh

            # Detectar puerto activo
            ACTIVE=$(grep -o "300[1-2]" /etc/nginx/sites-available/app.conf | head -1 || echo "3001")
            if [ "$ACTIVE" = "3001" ]; then
              NEW_ENV="green"
            else
              NEW_ENV="blue"
            fi

            echo "Desplegando nueva versión en $NEW_ENV"

            ./scripts/deploy.sh $NEW_ENV
            sleep 15

            # Health check de nginx
            if curl -sf http://127.0.0.1/health; then
              ./scripts/switch.sh $NEW_ENV
              echo "DESPLIEGUE EXITOSO → $NEW_ENV activo"
            else
              echo "FALLO → ejecutando rollback"
              ./scripts/rollback.sh
            fi
