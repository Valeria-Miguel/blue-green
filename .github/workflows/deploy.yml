name: Blue-Green Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Despliegue Blue-Green automático
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/imanolcamacho098/blue-green

            # Detectar cuál está activo ahora
            ACTIVE=$(sudo grep "127.0.0.1" /etc/nginx/sites-available/blue-green.conf | grep -o "808[1-2]")

            if [ "$ACTIVE" = "8081" ]; then
              NEW_ENV="green"
              NEW_PORT="8082"
  else
              NEW_ENV="blue"
              NEW_PORT="8081"
            fi

            echo "Entorno activo: $ACTIVE (Blue=8081, Green=8082)"
            echo "Desplegando nueva versión en: $NEW_ENV (puerto $NEW_PORT)"

            # Actualizar código
            git pull origin main

            # Desplegar en el entorno inactivo
            ./scripts/deploy.sh $NEW_ENV

            # Esperar a que arranque
            sleep 12

            # Health check simple
            if curl -s http://127.0.0.1:$NEW_PORT > /dev/null; then
              echo "Health check OK → Cambiando tráfico a $NEW_ENV"
              ./scripts/switch.sh $NEW_ENV
              echo "DESPLIEGUE EXITOSO - Ahora está en $NEW_ENV"
            else
              echo "HEALTH CHECK FALLÓ → Haciendo rollback automático"
              ./scripts/rollback.sh
              exit 1
            fi
